# Dubbo源码解析——服务暴露

<!-- vscode-markdown-toc -->
* 1. [前言](#)
* 2. [一个简易的暴露流程](#-1)
* 3. [服务暴露前的准备——_ServiceBean_](#_ServiceBean_)

<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->

##  1. <a name=''></a>前言

作为分布式框架，服务的暴露(导出)和服务的引用无疑是最关键的因素。Dubbo服务暴露的**方式**有两种：

1. 本地暴露，即JVM的本地调用，在xml中的配置如下:

```xml
<dubbo:service scope="local"/>
```

2. 远程通信调用，即跨网络的调用，在xml中的配置如下:

```xml
<dubbo:service scope="remote"/>
```

同时，Dubbo的服务暴露的**情况**有两种:

1. **延迟暴露，这种情况设置了暴露的延迟** :设置了延迟暴露，dubbo在Spring实例化bean（initializeBean）的时候会对实现了InitializingBean的类进行回调，回调方法是afterPropertySet()，如果设置了延迟暴露，dubbo在这个方法中进行服务的发布。
2. **非延迟暴露，通过设置delay=-1来延迟暴露** :没有设置延迟或者延迟为-1，dubbo会在Spring实例化完bean之后，在刷新容器最后一步发布ContextRefreshEvent事件的时候，通知实现了ApplicationListener的类进行回调onApplicationEvent，dubbo会在这个方法中发布服务。

***总结上面的说法，就是非延迟暴露在Spring容器刷新的时候暴露服务，延迟暴露在实例化bean之后的afterProperties方法中暴露。***

##  2. <a name='-1'></a>一个简易的暴露流程

1. Dubbo的服务导出始于Spring容器发布刷新事件，Dubbo接收到事件之后，会立刻执行服务导出逻辑
2. Dubbo进行导出前置工作，用于检查参数，组装URL
3. 执行导出服务，分为本地导出与远程导出
4. 向注册中心注册服务，用于服务发现


##  3. <a name='_ServiceBean_'></a>服务暴露前的准备——_ServiceBean_

首先先来看看dubbo关于service provider的一个xml配置：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"
       xmlns="http://www.springframework.org/schema/beans"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd">

    <!-- 提供方应用信息，用于计算依赖关系 -->
    <dubbo:application name="demo-provider"/>

    <!-- 使用zookeeper注册中心，并使用curator客户端 -->
    <dubbo:registry protocol="zookeeper" address="10.211.55.5:2181" client="curator"/>

    <!-- 用dubbo协议在20880端口暴露服务 -->
    <dubbo:protocol name="dubbo" port="20880"/>

    <!-- 和本地bean一样实现服务 -->
    <bean id="demoService" class="com.alibaba.dubbo.demo.provider.DemoServiceImpl"/>
    <!--<bean id="demo2Service" class="com.alibaba.dubbo.demo.provider.Demo2ServiceImpl"/>-->

    <!-- 声明需要暴露的服务接口 -->
    <dubbo:service interface="com.alibaba.dubbo.demo.DemoService" ref="demoService"/>
    <!--<dubbo:service interface="com.alibaba.dubbo.demo.Demo2Service" ref="demo2Service"/>-->
</beans>
```

服务暴露是由`com.alibaba.dubbo.config.spring.ServiceBean`这个类来实现的，这个类是spring通过解析`<dubbo:service>`节点创建的单例Bean，每一个`<dubbo:service>`都会创建一个ServiceBean。

服务导出的入口方法是`ServiceBean#onApplicationEvent` ，`#onApplicationEvent`是一个事件响应方法，该方法会在收到 Spring 上下文刷新事件后执行服务导出操作。

